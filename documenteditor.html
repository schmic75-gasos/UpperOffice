<!DOCTYPE html><html lang="cs"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>UpperOffice - document editor</title><link rel="stylesheet" href="untiteld-1.CSS"><style>*{box-sizing:border-box}body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f4f4f4}header{background:#333;color:#fff;padding:10px;display:flex;flex-wrap:wrap;gap:8px;align-items:center}button,input[type=color],input[type=number],select{padding:6px 10px;cursor:pointer;border:none;border-radius:4px;background:#fff;color:#000}button:hover{background:#eaeaea}label.small{color:#fff;font-size:13px;margin-left:6px}#editor{margin:10px;min-height:500px;display:block}.page{border:1px solid #ccc;background:#fff;margin-bottom:10px;position:relative;overflow:hidden;padding:12px;box-sizing:border-box;width:21cm;height:29.7cm;color:#000}.control-group{display:flex;gap:6px;align-items:center}.tiny{width:90px;padding:6px}.loading-spinner{display:inline-block;width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid #3498db;border-radius:50%;animation:spin 1s linear infinite;margin-right:10px}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.conversion-notice{background:#e3f2fd;border:1px solid #2196f3;border-radius:8px;padding:16px;margin:16px 0;font-size:14px;color:#1976d2}.conversion-notice.success{background:#e8f5e8;border-color:#4caf50;color:#2e7d32}.conversion-notice.warning{background:#fff3cd;border-color:#ffc107;color:#856404}</style></head><body><div class="gtranslate_wrapper"></div>
<script>window.gtranslateSettings = {"default_language":"en","native_language_names":true,"detect_browser_language":true,"wrapper_selector":".gtranslate_wrapper"}</script>
<script src="https://cdn.gtranslate.net/widgets/latest/float.js" defer></script><header><a href="index.html" class="logo">UPPER OFFICE</a><div class="navigation"><nav><li class="nav-item"><a href="Your_projects.html" class="nav-link">Your Projects</a></li><li class="nav-item"><a href="Users_projects.html" class="nav-link">Users Projects</a></li><li class="nav-item"><a href="User_guide.html" class="nav-link">User Guide</a></li><li class="nav-item"><a href="Suport_us.html" class="nav-link">Support Us</a></li><li class="nav-item"><a href="cloud.html" class="nav-link">Cloud Storage</a></li><li class="nav-item login-container"><a href="Login.html" class="nav-link login-link">üë®‚Äçüöí</a><div class="login-tooltip">Login is not required, but if you want to save your work you'll need an account</div></li></nav></div></header><br><header><div class="control-group"><button id="btnBold"><b>B</b></button><button id="btnItalic"><i>I</i></button><button id="btnUnderline"><u>U</u></button></div><select id="fontName"><option value="Arial">Arial</option><option value="Times New Roman">Times New Roman</option><option value="Courier New">Courier New</option><option value="Verdana">Verdana</option></select><select id="fontSize"><option value="1">8px</option><option value="2">10px</option><option value="3" selected="selected">12px</option><option value="4">14px</option><option value="5">18px</option><option value="6">24px</option><option value="7">36px</option></select><input type="color" id="colorPicker"><div class="control-group"><button id="left">Left</button><button id="center">Center</button><button id="right">Right</button></div><div class="control-group"><button id="ul">‚Ä¢ List</button><button id="ol">1. List</button></div><button id="toggleDir">LTR / RTL</button><button id="saveDoc">Export .DOC</button><button id="saveToCloud">üíæ Save to Cloud</button><button id="loadFromCloud">‚òÅÔ∏è Load from Cloud</button><label class="small">≈†√≠≈ôka (cm):</label><input type="number" id="widthInput" class="tiny" min="1" step="0.1" value="21"><button id="setWidth" class="tiny">Nastavit ≈°√≠≈ôku</button><label class="small">V√Ω≈°ka (cm):</label><input type="number" id="heightInput" class="tiny" min="1" step="0.1" value="29.7"><button id="setHeight" class="tiny">Nastavit v√Ω≈°ku</button><label class="small">Zleva (cm):</label><input type="number" id="indentLeft" class="tiny" min="0" step="0.1" value="0"><button id="setIndentLeft" class="tiny">Nastavit</button><label class="small">Zprava (cm):</label><input type="number" id="indentRight" class="tiny" min="0" step="0.1" value="0"><button id="setIndentRight" class="tiny">Nastavit</button><label class="small">Shora (cm):</label><input type="number" id="indentTop" class="tiny" min="0" step="0.1" value="0"><button id="setIndentTop" class="tiny">Nastavit</button><label class="small">Zdola (cm):</label><input type="number" id="indentBottom" class="tiny" min="0" step="0.1" value="0"><button id="setIndentBottom" class="tiny">Nastavit</button><span id="currentDim" class="small" style="margin-left:10px"></span></header><div id="editor"><div class="page" contenteditable="true"><div><br></div></div></div><script>const editor = document.getElementById('editor');

function exec(cmd, val = null) { document.execCommand(cmd, false, val); }

document.getElementById('btnBold').addEventListener('click', ()=> exec('bold'));
document.getElementById('btnItalic').addEventListener('click', ()=> exec('italic'));
document.getElementById('btnUnderline').addEventListener('click', ()=> exec('underline'));

document.getElementById('fontName').addEventListener('change', function(){ exec('fontName', this.value); });
document.getElementById('fontSize').addEventListener('change', function(){ exec('fontSize', this.value); });
document.getElementById('colorPicker').addEventListener('input', function(){ exec('foreColor', this.value); });

document.getElementById('left').addEventListener('click', ()=> exec('justifyLeft'));
document.getElementById('center').addEventListener('click', ()=> exec('justifyCenter'));
document.getElementById('right').addEventListener('click', ()=> exec('justifyRight'));

document.getElementById('ul').addEventListener('click', ()=> exec('insertUnorderedList'));
document.getElementById('ol').addEventListener('click', ()=> exec('insertOrderedList'));

document.getElementById('toggleDir').addEventListener('click', function(){
  const activePage = document.activeElement.closest('.page');
  if(activePage) activePage.dir = activePage.dir === 'ltr' ? 'rtl' : 'ltr';
});

document.getElementById('saveDoc').addEventListener('click', function(){
  const widthCm = document.getElementById('widthInput').value;   // in cm
  const heightCm = document.getElementById('heightInput').value; // in cm

  // 1 cm = 28.3464567 pt
  const cmToPt = cm => cm * 28.3464567;

  const widthPt = cmToPt(widthCm);
  const heightPt = cmToPt(heightCm);

  const header =
    "<html xmlns:o='urn:schemas-microsoft-com:office:office' " +
    "xmlns:w='urn:schemas-microsoft-com:office:word' " +
    "xmlns='http://www.w3.org/TR/REC-html40'>" +
    "<head>" +
    "<meta charset='utf-8'>" +
    "<style>" +
      "@page WordSection1 { size: " + widthPt + "pt " + heightPt + "pt; } " +
      "div.WordSection1 { page: WordSection1; }" +
    "</style>" +
    "</head><body class='WordSection1'>";

  const footer = "</body></html>";
  const content = editor.innerHTML;

  const blob = new Blob([header + content + footer], { type: 'application/msword' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'dokument.doc';
  link.click();
});


// Nastaven√≠ rozmƒõr≈Ø a odsazen√≠
function setEditorWidthCm(cm){ document.querySelectorAll('.page').forEach(p=>p.style.width=cm+'cm'); updateCurrentDim();}
function setEditorHeightCm(cm){ document.querySelectorAll('.page').forEach(p=>p.style.height=cm+'cm'); updateCurrentDim();}
function setIndentLeftCm(cm){ document.querySelectorAll('.page').forEach(p=>p.style.paddingLeft=parseFloat(cm)+'cm'); }
function setIndentRightCm(cm){ document.querySelectorAll('.page').forEach(p=>p.style.paddingRight=parseFloat(cm)+'cm'); }
function setIndentTopCm(cm){ document.querySelectorAll('.page').forEach(p=>p.style.paddingTop=parseFloat(cm)+'cm'); }
function setIndentBottomCm(cm){ document.querySelectorAll('.page').forEach(p=>p.style.paddingBottom=parseFloat(cm)+'cm'); }

document.getElementById('setWidth').addEventListener('click', ()=> setEditorWidthCm(document.getElementById('widthInput').value));
document.getElementById('setHeight').addEventListener('click', ()=> setEditorHeightCm(document.getElementById('heightInput').value));
document.getElementById('setIndentLeft').addEventListener('click', ()=> setIndentLeftCm(document.getElementById('indentLeft').value));
document.getElementById('setIndentRight').addEventListener('click', ()=> setIndentRightCm(document.getElementById('indentRight').value));
document.getElementById('setIndentTop').addEventListener('click', ()=> setIndentTopCm(document.getElementById('indentTop').value));
document.getElementById('setIndentBottom').addEventListener('click', ()=> setIndentBottomCm(document.getElementById('indentBottom').value));

function updateCurrentDim(){
  const page = document.querySelector('.page');
  const style = getComputedStyle(page);
  const pxToCm = px => (px / 37.7952755906).toFixed(2);
  document.getElementById('currentDim').textContent = `Aktu√°lnƒõ: ${pxToCm(parseFloat(style.width))} cm √ó ${pxToCm(parseFloat(style.height))} cm`;
}
updateCurrentDim();
window.addEventListener('resize', updateCurrentDim);

function addNewPage(){
  const lastPage = editor.lastElementChild;
  const newPage = lastPage.cloneNode(true);
  newPage.innerHTML = "<div><br></div>";
  editor.appendChild(newPage);
  placeCaretAtEnd(newPage);
}

function placeCaretAtEnd(el){
  el.focus();
  if(typeof window.getSelection!="undefined" && typeof document.createRange!="undefined"){
    const range = document.createRange();
    range.selectNodeContents(el);
    range.collapse(false);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  }
}

editor.addEventListener('input', ()=>{
  const lastPage = editor.lastElementChild;
  if(lastPage.scrollHeight > lastPage.clientHeight){
    addNewPage();
  }
});

document.getElementById('saveDoc').addEventListener('click', function() {
    const pages = document.querySelectorAll('.page');
    let content = '';
    pages.forEach(p => {
        const style = getComputedStyle(p);
        const inlineStyle = `
            width: ${style.width};
            height: ${style.height};
            padding-top: ${style.paddingTop};
            padding-bottom: ${style.paddingBottom};
            padding-left: ${style.paddingLeft};
            padding-right: ${style.paddingRight};
            font-family: ${style.fontFamily};
            font-size: ${style.fontSize};
            color: ${style.color};
            text-align: ${style.textAlign};
        `;
        content += `<div style="${inlineStyle}">${p.innerHTML}</div><br>`;
    });

    const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' "+
                   "xmlns:w='urn:schemas-microsoft-com:office:word' "+
                   "xmlns='http://www.w3.org/TR/REC-html40'>"+
                   "<head><meta charset='utf-8'></head><body>";
    const footer = "</body></html>";

    const blob = new Blob([header + content + footer], { type: 'application/msword' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'dokument.doc';
    link.click();
});</script><script>
document.getElementById('saveToCloud').addEventListener('click', function() {
    if (!localStorage.token) {
        alert('Please login to save to cloud');
        return;
    }

    const content = editor.innerHTML;
    const blob = new Blob([content], { type: 'application/msword' });
    const file = new File([blob], 'document.doc', { type: 'application/msword' });
    uploadToCloud(file);
});

async function uploadToCloud(file) {
    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch('/api/cloud/upload', {
            method: 'POST',
            headers: {
                'Authorization': localStorage.token
            },
            body: formData
        });

        const result = await response.json();
        
        if (response.ok) {
            alert('Document saved to cloud successfully!');
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error uploading file: ' + error.message);
    }
}</script><script>
document.getElementById('loadFromCloud').addEventListener('click', openCloudModal);

function openCloudModal() {
    if (!localStorage.token) {
        alert('Please login to access cloud files');
        return;
    }

    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    `;
    
    modal.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">Load Document from Cloud</h2>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 20px; cursor: pointer;">‚úï</button>
            </div>
            <div id="cloudDocsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px;"></div>
            <div id="cloudDocStatus" style="margin-top: 20px; text-align: center; color: #666;"></div>
        </div>
    `;
    
    document.body.appendChild(modal);
    loadCloudDocuments();
}

async function loadCloudDocuments() {
    const statusEl = document.getElementById('cloudDocStatus');
    const gridEl = document.getElementById('cloudDocsGrid');
    
    statusEl.textContent = 'Loading documents...';
    statusEl.style.color = '#666';
    
    try {
        const response = await fetch('/api/cloud/files', {
            headers: {
                'Authorization': localStorage.token
            }
        });

        if (response.ok) {
            const files = await response.json();
            const docFiles = files.filter(file => file.type === 'document');
            
            if (docFiles.length === 0) {
                statusEl.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìÅ</div>
                        <h4 style="margin-bottom: 8px;">No documents found</h4>
                        <p style="color: #666; font-size: 14px;">Upload some documents to your cloud storage first.</p>
                    </div>
                `;
                return;
            }

            gridEl.innerHTML = '';
            statusEl.textContent = `Found ${docFiles.length} documents`;

            docFiles.forEach(file => {
                const fileCard = document.createElement('div');
                fileCard.style.cssText = `
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border-radius: 12px;
                    padding: 20px;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.3s;
                    border: 2px solid transparent;
                    color: white;
                    position: relative;
                    overflow: hidden;
                `;
                
                const fileExtension = file.filename.split('.').pop().toUpperCase();
                const isWordDoc = ['DOC', 'DOCX'].includes(fileExtension);
                
                fileCard.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 12px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">
                        ${isWordDoc ? 'üìù' : 'üìÑ'}
                    </div>
                    <div style="font-size: 14px; font-weight: bold; margin-bottom: 8px; line-height: 1.3; height: 2.8rem; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                        ${file.filename}
                    </div>
                    <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">
                        ${fileExtension} ‚Ä¢ ${formatFileSize(file.size)}
                    </div>
                    <div style="font-size: 10px; opacity: 0.7;">
                        ${new Date(file.upload_date).toLocaleDateString()}
                    </div>
                    ${isWordDoc ? 
                        '<div style="position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 8px; font-size: 9px;">Auto-Convert</div>' : 
                        ''
                    }
                `;

                fileCard.addEventListener('click', async () => {
                    statusEl.innerHTML = `<div style="color: #2196f3;">üîÑ Loading and converting "${file.filename}"...</div>`;
                    await loadDocumentFromCloud(file.id);
                    document.querySelector('[style*="position: fixed; top: 0"]').remove();
                });

                fileCard.addEventListener('mouseenter', () => {
                    fileCard.style.transform = 'translateY(-4px) scale(1.02)';
                    fileCard.style.boxShadow = '0 8px 25px rgba(0,0,0,0.3)';
                    fileCard.style.borderColor = 'rgba(255,255,255,0.5)';
                });

                fileCard.addEventListener('mouseleave', () => {
                    fileCard.style.transform = 'translateY(0) scale(1)';
                    fileCard.style.boxShadow = 'none';
                    fileCard.style.borderColor = 'transparent';
                });

                gridEl.appendChild(fileCard);
            });
        } else {
            statusEl.innerHTML = `<div style="color: #f44336;">‚ùå Error loading cloud files</div>`;
        }
    } catch (error) {
        statusEl.innerHTML = `<div style="color: #f44336;">‚ùå Error: ${error.message}</div>`;
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

async function loadDocumentFromCloud(fileId) {
    const statusEl = document.getElementById('cloudDocStatus') || { textContent: '' };
    statusEl.textContent = 'Converting document...';
    
    try {
        const convertResponse = await fetch(`/api/cloud/convert/${fileId}`, {
            headers: {
                'Authorization': localStorage.token
            }
        });

        if (convertResponse.ok) {
            const result = await convertResponse.json();
            
            if (result.html) {
                const firstPage = document.querySelector('.page');
                if (firstPage) {
                    firstPage.innerHTML = '<div>' + result.html + '</div>';
                    statusEl.textContent = 'Document loaded successfully!';
                    setTimeout(() => {
                        alert(`Document converted using ${result.method || 'auto-conversion'}. Some formatting may differ from the original.`);
                    }, 500);
                }
                return;
            }
        }
        const downloadResponse = await fetch(`/api/cloud/download/${fileId}`, {
            headers: {
                'Authorization': localStorage.token
            }
        });

        if (downloadResponse.ok) {
            const blob = await downloadResponse.blob();
            
            if (blob.type.includes('word') || blob.type.includes('document')) {
                await convertAndLoadDocFile(blob, fileId);
            } else {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const firstPage = document.querySelector('.page');
                    if (firstPage) {
                        firstPage.innerHTML = e.target.result;
                    }
                };
                reader.readAsText(blob);
            }
        } else {
            statusEl.textContent = 'Error loading document';
        }
    } catch (error) {
        statusEl.textContent = 'Error: ' + error.message;
        console.error('Load error:', error);
    }
}

async function convertAndLoadDocFile(blob, fileId) {
    const formData = new FormData();
    formData.append('file', blob, `document_${fileId}.doc`);
    
    try {
        const response = await fetch('/api/convert/doc-to-html', {
            method: 'POST',
            headers: {
                'Authorization': localStorage.token
            },
            body: formData
        });

        if (response.ok) {
            const result = await response.json();
            
            if (result.html) {
                const firstPage = document.querySelector('.page');
                if (firstPage) {
                    firstPage.innerHTML = '<div>' + result.html + '</div>';
                    
                    // Show conversion info
                    setTimeout(() => {
                        const conversionInfo = document.createElement('div');
                        conversionInfo.style.cssText = `
                            background: #e3f2fd;
                            border: 1px solid #2196f3;
                            border-radius: 4px;
                            padding: 10px;
                            margin: 10px 0;
                            font-size: 12px;
                            color: #1976d2;
                        `;
                        conversionInfo.innerHTML = `
                            <strong>üîÑ Document Converted</strong><br>
                            Converted using ${result.method}. Some complex formatting may not be preserved.
                        `;
                        firstPage.insertBefore(conversionInfo, firstPage.firstChild);
                    }, 100);
                }
            }
        } else {
            throw new Error('Conversion failed');
        }
    } catch (error) {
        console.error('Conversion error:', error);
     
        const firstPage = document.querySelector('.page');
        if (firstPage) {
            firstPage.innerHTML = `
                <div style="padding: 40px; text-align: center; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üìÑ</div>
                    <h3 style="color: #856404; margin-bottom: 16px;">Document Ready for Editing</h3>
                    <p style="color: #856404; margin-bottom: 20px;">
                        Your document has been loaded from cloud storage.<br>
                        Start typing to begin editing, or use the formatting tools above.
                    </p>
                    <button onclick="this.parentElement.parentElement.innerHTML = '<div><br></div>'" 
                            style="background: #856404; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                        Start Editing
                    </button>
                </div>
            `;
        }
    }
}</script><script>// Check for cloud file in URL parameters
const urlParams = new URLSearchParams(window.location.search);
const cloudFileId = urlParams.get('cloudFile');
if (cloudFileId && localStorage.token) {
    loadDocumentFromCloud(cloudFileId);
}
</script></body></html>